<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>En-Suite & Bathrooms – Professional 2D Planner</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>

<style>
body{
    margin:0;
    font-family:Arial, Helvetica, sans-serif;
    background:#f4f4f4;
}
header{
    background:#111;
    color:#fff;
    padding:18px;
    text-align:center;
    font-size:22px;
    letter-spacing:1px;
}
#toolbar{
    background:#fff;
    padding:12px;
    border-bottom:1px solid #ddd;
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
}
select,button{
    padding:6px 10px;
    font-size:14px;
}
#status{
    margin-left:auto;
    font-size:13px;
    color:#555;
}
canvas{
    background:#fff;
    border:1px solid #ccc;
}
</style>
</head>

<body>

<header>En-Suite & Bathrooms – Professional 2D Planner</header>

<div id="toolbar">
<select id="tool">
<option value="select">Select / Move</option>
<option value="wall">Draw Wall</option>
<option value="door">Door</option>
<option value="window">Window</option>
<option value="toilet">Toilet</option>
<option value="basin">Basin</option>
<option value="bath">Bath</option>
<option value="shower">Shower</option>
<option value="radiator">Radiator</option>
<option value="manhole">Manhole</option>
<option value="grass">Grass</option>
<option value="socket">Socket</option>
<option value="light">Light</option>
</select>

<button onclick="deleteSelected()">Delete</button>
<button onclick="savePlan()">Save Plan</button>
<button onclick="loadPlan()">Load Plan</button>
<button onclick="exportPNG()">Export PNG</button>

<div id="status">Mode: Select</div>
</div>

<canvas id="planner" width="2400" height="1400"></canvas>

<script>

/* ===============================
   INITIAL SETUP
================================= */

const canvas = new fabric.Canvas("planner", {
    preserveObjectStacking:true,
    selection:true
});

let currentTool = "select";
let drawingWall = false;
let wallLine = null;
let isPanning = false;

const gridSize = 40;
const canvasWidth = 2400;
const canvasHeight = 1400;

/* ===============================
   GRID SYSTEM
================================= */

function drawGrid(){
    for(let i=0;i<=canvasWidth/gridSize;i++){
        const vertical = new fabric.Line([i*gridSize,0,i*gridSize,canvasHeight],{
            stroke:"#eee",
            selectable:false,
            evented:false,
            excludeFromExport:true
        });
        canvas.add(vertical);
    }
    for(let i=0;i<=canvasHeight/gridSize;i++){
        const horizontal = new fabric.Line([0,i*gridSize,canvasWidth,i*gridSize],{
            stroke:"#eee",
            selectable:false,
            evented:false,
            excludeFromExport:true
        });
        canvas.add(horizontal);
    }
}
drawGrid();

/* ===============================
   TOOL MANAGEMENT
================================= */

const toolSelect = document.getElementById("tool");
const statusText = document.getElementById("status");

toolSelect.addEventListener("change", function(){
    currentTool = this.value;
    drawingWall = false;
    canvas.discardActiveObject();
    canvas.requestRenderAll();
    statusText.innerText = "Mode: " + this.options[this.selectedIndex].text;
});

/* ===============================
   WALL ENGINE (ISOLATED)
================================= */

canvas.on("mouse:down", function(opt){

    if(currentTool === "wall"){
        drawingWall = true;
        const pointer = canvas.getPointer(opt.e);

        wallLine = new fabric.Line(
            [snap(pointer.x), snap(pointer.y), snap(pointer.x), snap(pointer.y)],
            {
                stroke:"#333",
                strokeWidth:6,
                selectable:true,
                objectCaching:false
            }
        );

        canvas.add(wallLine);
    }

    if(opt.e.code === "Space"){
        isPanning = true;
        canvas.selection = false;
    }
});

canvas.on("mouse:move", function(opt){

    if(drawingWall && currentTool === "wall"){
        const pointer = canvas.getPointer(opt.e);
        wallLine.set({
            x2: snap(pointer.x),
            y2: snap(pointer.y)
        });
        canvas.requestRenderAll();
    }

    if(isPanning){
        const delta = new fabric.Point(opt.e.movementX, opt.e.movementY);
        canvas.relativePan(delta);
    }
});

canvas.on("mouse:up", function(){
    drawingWall = false;
    isPanning = false;
    canvas.selection = true;
});

/* ===============================
   SNAP TO GRID
================================= */

function snap(value){
    return Math.round(value / gridSize) * gridSize;
}

/* ===============================
   ZOOM
================================= */

canvas.on("mouse:wheel", function(opt){
    let zoom = canvas.getZoom();
    zoom *= 0.999 ** opt.e.deltaY;
    zoom = Math.min(Math.max(zoom,0.5),3);
    canvas.zoomToPoint({x:opt.e.offsetX,y:opt.e.offsetY}, zoom);
    opt.e.preventDefault();
});

/* ===============================
   SVG SYMBOL LIBRARY
================================= */

function addSVG(svg){
    fabric.loadSVGFromString(svg, function(objects, options){
        const obj = fabric.util.groupSVGElements(objects, options);
        obj.set({
            left:600,
            top:400,
            originX:"center",
            originY:"center",
            cornerStyle:"circle",
            cornerSize:8,
            transparentCorners:false
        });
        canvas.add(obj).setActiveObject(obj);
        canvas.requestRenderAll();
    });
}

const symbols = {

/* Proper CAD-style fixtures */

toilet:`<svg viewBox="0 0 120 200">
<rect x="30" y="0" width="60" height="45" stroke="#000" fill="none" stroke-width="3"/>
<ellipse cx="60" cy="125" rx="40" ry="60" stroke="#000" fill="none" stroke-width="3"/>
<ellipse cx="60" cy="125" rx="20" ry="35" stroke="#000" fill="none" stroke-width="2"/>
</svg>`,

basin:`<svg viewBox="0 0 160 100">
<rect x="10" y="35" width="140" height="50" rx="20" stroke="#000" fill="none" stroke-width="3"/>
<circle cx="80" cy="60" r="5" fill="#000"/>
<rect x="70" y="5" width="20" height="25" stroke="#000" fill="none" stroke-width="3"/>
</svg>`,

bath:`<svg viewBox="0 0 260 120">
<rect x="10" y="25" width="240" height="80" rx="50" stroke="#000" fill="none" stroke-width="3"/>
<circle cx="210" cy="35" r="6" fill="#000"/>
<circle cx="230" cy="35" r="6" fill="#000"/>
</svg>`,

shower:`<svg viewBox="0 0 120 120">
<rect x="10" y="10" width="100" height="100" stroke="#000" fill="none" stroke-width="3"/>
<circle cx="60" cy="60" r="6" fill="#000"/>
</svg>`,

radiator:`<svg viewBox="0 0 150 240">
${Array.from({length:8}).map((_,i)=>`<rect x="${20+i*14}" y="10" width="8" height="220" stroke="#000" fill="none" stroke-width="3"/>`).join('')}
</svg>`,

door:`<svg viewBox="0 0 160 160">
<line x1="10" y1="150" x2="150" y2="150" stroke="#000" stroke-width="6"/>
<path d="M10 150 A140 140 0 0 1 150 10" fill="none" stroke="#000" stroke-width="2"/>
</svg>`,

window:`<svg viewBox="0 0 200 40">
<rect x="10" y="10" width="180" height="20" stroke="#000" fill="none" stroke-width="3"/>
</svg>`,

manhole:`<svg viewBox="0 0 150 150">
<circle cx="75" cy="75" r="65" stroke="#000" fill="none" stroke-width="3"/>
${Array.from({length:6}).map((_,i)=>`<line x1="20" y1="${40+i*15}" x2="130" y2="${40+i*15}" stroke="#000"/>`).join('')}
</svg>`,

grass:`<svg viewBox="0 0 150 150">
<rect width="150" height="150" stroke="#000" fill="none" stroke-width="2"/>
${Array.from({length:10}).map((_,i)=>`<line x1="${15+i*13}" y1="150" x2="${25+i*13}" y2="100" stroke="#000"/>`).join('')}
</svg>`,

socket:`<svg viewBox="0 0 100 100">
<rect x="15" y="15" width="70" height="70" stroke="#000" fill="none" stroke-width="3"/>
<circle cx="40" cy="50" r="6" fill="#000"/>
<circle cx="60" cy="50" r="6" fill="#000"/>
</svg>`,

light:`<svg viewBox="0 0 100 100">
<circle cx="50" cy="50" r="35" stroke="#000" fill="none" stroke-width="3"/>
<circle cx="50" cy="50" r="6" fill="#000"/>
</svg>`
};

/* Auto add symbol */
toolSelect.addEventListener("change", function(){
    if(symbols[this.value]){
        addSVG(symbols[this.value]);
        this.value="select";
        currentTool="select";
        statusText.innerText="Mode: Select";
    }
});

/* ===============================
   OBJECT CONTROLS
================================= */

canvas.on("object:moving", function(opt){
    if(currentTool !== "wall"){
        opt.target.set({
            left:snap(opt.target.left),
            top:snap(opt.target.top)
        });
    }
});

/* ===============================
   DELETE SUPPORT
================================= */

function deleteSelected(){
    const obj = canvas.getActiveObject();
    if(obj) canvas.remove(obj);
}

document.addEventListener("keydown",function(e){
    if(e.key==="Delete"){
        deleteSelected();
    }
});

/* ===============================
   SAVE / LOAD
================================= */

function savePlan(){
    const json = JSON.stringify(canvas.toJSON(["excludeFromExport"]));
    localStorage.setItem("ensuitePlan", json);
    alert("Plan Saved");
}

function loadPlan(){
    const json = localStorage.getItem("ensuitePlan");
    if(json){
        canvas.loadFromJSON(json,function(){
            drawGrid();
            canvas.renderAll();
        });
    }
}

/* ===============================
   EXPORT
================================= */

function exportPNG(){
    const link = document.createElement("a");
    link.href = canvas.toDataURL({
        format:"png",
        multiplier:2
    });
    link.download="ensuite-plan.png";
    link.click();
}

</script>
</body>
</html>
