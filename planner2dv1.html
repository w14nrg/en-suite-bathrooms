<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>En-Suite 2D Planner</title>

<style>
body {
  margin:0;
  font-family: system-ui, -apple-system, sans-serif;
  background:#f3f4f6;
  overflow:hidden;
}

#sidebar {
  position:absolute;
  left:0;
  top:0;
  bottom:0;
  width:260px;
  background:#ffffff;
  border-right:1px solid #e5e7eb;
  padding:20px;
  box-sizing:border-box;
  overflow-y:auto;
}

h2 {
  margin-top:0;
  font-size:18px;
}

button {
  width:100%;
  padding:10px;
  margin-bottom:8px;
  border-radius:8px;
  border:1px solid #d1d5db;
  background:white;
  cursor:pointer;
}

button.active {
  background:#111827;
  color:white;
}

canvas {
  position:absolute;
  left:260px;
  top:0;
  background:#faf9f6;
}
</style>
</head>

<body>

<div id="sidebar">
  <h2>Tools</h2>

  <button onclick="setTool('select')" id="tool-select" class="active">Select / Move</button>
  <button onclick="setTool('wall')" id="tool-wall">Draw Wall</button>
  <button onclick="setTool('hot')" id="tool-hot">Hot Pipe</button>
  <button onclick="setTool('cold')" id="tool-cold">Cold Pipe</button>
  <button onclick="setTool('drain')" id="tool-drain">Drain</button>

  <h2>Fixtures</h2>

  <button onclick="addFixture('toilet')">Toilet 700x360</button>
  <button onclick="addFixture('bath')">Bath 1700x700</button>
  <button onclick="addFixture('shower')">Shower 900x900</button>
  <button onclick="addFixture('vanity')">Vanity 600x450</button>
  <button onclick="addFixture('radiator')">Towel Rad 500x1200</button>
  <button onclick="addFixture('door')">Door 762</button>

  <h2>Export</h2>
  <button onclick="exportPNG()">Export PNG</button>
</div>

<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let tool = "select";
let scale = 0.5; // zoom level
let offsetX = 400;
let offsetY = 200;

const GRID = 100; // 100mm grid

let fixtures = [];
let walls = [];
let pipes = [];

let selected = null;
let drawing = null;
let dragging = false;
let dragOffset = {x:0,y:0};

function resize(){
  canvas.width = window.innerWidth - 260;
  canvas.height = window.innerHeight;
  draw();
}
window.addEventListener("resize", resize);
resize();

function setTool(t){
  tool = t;
  document.querySelectorAll("#sidebar button").forEach(b=>b.classList.remove("active"));
  document.getElementById("tool-"+t)?.classList.add("active");
}

function worldX(x){ return (x - offsetX)/scale; }
function worldY(y){ return (y - offsetY)/scale; }

function snap(v){ return Math.round(v/GRID)*GRID; }

function addFixture(type){
  const sizes = {
    toilet:{w:360,h:700},
    bath:{w:700,h:1700},
    shower:{w:900,h:900},
    vanity:{w:600,h:450},
    radiator:{w:500,h:1200},
    door:{w:40,h:762}
  };
  fixtures.push({
    type,
    x:0,
    y:0,
    w:sizes[type].w,
    h:sizes[type].h,
    rotation:0
  });
  draw();
}

function drawGrid(){
  ctx.strokeStyle="#e5e7eb";
  ctx.lineWidth=1;
  for(let x = offsetX % (GRID*scale); x < canvas.width; x += GRID*scale){
    ctx.beginPath();
    ctx.moveTo(x,0);
    ctx.lineTo(x,canvas.height);
    ctx.stroke();
  }
  for(let y = offsetY % (GRID*scale); y < canvas.height; y += GRID*scale){
    ctx.beginPath();
    ctx.moveTo(0,y);
    ctx.lineTo(canvas.width,y);
    ctx.stroke();
  }
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawGrid();

  ctx.save();
  ctx.translate(offsetX,offsetY);
  ctx.scale(scale,scale);

  // Walls
  ctx.strokeStyle="#4b5563";
  ctx.lineWidth=20;
  walls.forEach(w=>{
    ctx.beginPath();
    ctx.moveTo(w.x1,w.y1);
    ctx.lineTo(w.x2,w.y2);
    ctx.stroke();
  });

  // Pipes
  pipes.forEach(p=>{
    ctx.strokeStyle = p.type=="hot"?"#ef4444":p.type=="cold"?"#3b82f6":"#111827";
    ctx.lineWidth=10;
    if(p.type=="drain") ctx.setLineDash([30,20]);
    ctx.beginPath();
    ctx.moveTo(p.x1,p.y1);
    ctx.lineTo(p.x2,p.y2);
    ctx.stroke();
    ctx.setLineDash([]);
  });

  // Fixtures
  fixtures.forEach(f=>{
    ctx.save();
    ctx.translate(f.x,f.y);
    ctx.rotate(f.rotation);

    ctx.fillStyle="#ffffff";
    ctx.strokeStyle="#111827";
    ctx.lineWidth=4;

    if(f.type=="door"){
      ctx.beginPath();
      ctx.moveTo(0,0);
      ctx.lineTo(0,f.h);
      ctx.stroke();
      ctx.beginPath();
      ctx.arc(0,0,f.h,0,Math.PI/2);
      ctx.stroke();
    } else {
      ctx.beginPath();
      ctx.rect(-f.w/2,-f.h/2,f.w,f.h);
      ctx.fill();
      ctx.stroke();
    }

    if(selected===f){
      ctx.strokeStyle="#d97706";
      ctx.lineWidth=6;
      ctx.strokeRect(-f.w/2,-f.h/2,f.w,f.h);
    }

    ctx.restore();
  });

  ctx.restore();
}

canvas.addEventListener("mousedown",e=>{
  const wx = snap(worldX(e.offsetX));
  const wy = snap(worldY(e.offsetY));

  if(tool==="select"){
    for(let i=fixtures.length-1;i>=0;i--){
      let f=fixtures[i];
      if(wx>f.x-f.w/2 && wx<f.x+f.w/2 &&
         wy>f.y-f.h/2 && wy<f.y+f.h/2){
        selected=f;
        dragging=true;
        dragOffset.x=wx-f.x;
        dragOffset.y=wy-f.y;
        return;
      }
    }
    selected=null;
  }
  else if(tool==="wall" || tool==="hot" || tool==="cold" || tool==="drain"){
    drawing={x1:wx,y1:wy,type:tool};
  }
  draw();
});

canvas.addEventListener("mousemove",e=>{
  const wx = snap(worldX(e.offsetX));
  const wy = snap(worldY(e.offsetY));

  if(dragging && selected){
    selected.x = wx - dragOffset.x;
    selected.y = wy - dragOffset.y;
    draw();
  }
});

canvas.addEventListener("mouseup",e=>{
  dragging=false;

  if(drawing){
    drawing.x2 = snap(worldX(e.offsetX));
    drawing.y2 = snap(worldY(e.offsetY));
    if(drawing.type==="wall") walls.push(drawing);
    else pipes.push(drawing);
    drawing=null;
  }
  draw();
});

canvas.addEventListener("wheel",e=>{
  e.preventDefault();
  const zoom = e.deltaY>0 ? 0.9 : 1.1;
  scale*=zoom;
  draw();
});

window.addEventListener("keydown",e=>{
  if(e.key==="Delete" && selected){
    fixtures=fixtures.filter(f=>f!==selected);
    selected=null;
    draw();
  }
  if(e.key==="r" && selected){
    selected.rotation+=Math.PI/2;
    draw();
  }
});

function exportPNG(){
  const link=document.createElement("a");
  link.download="ensuite-plan.png";
  link.href=canvas.toDataURL("image/png");
  link.click();
}

draw();
</script>
</body>
</html>
